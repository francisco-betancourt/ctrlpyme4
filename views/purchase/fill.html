{{left_sidebar_enabled = True}}
{{extend 'layout.html'}}


<style>
  #items_list {
    margin-bottom: 15px;
  }
</style>


{{block left_sidebar}}
<h1>{{=T('Purchase')}} {{=purchase.id}}</h1>
  {{=form}}
{{end}}


<h1>{{=T('Add')}} Items</h1>
{{=stock_items_script}}
{{include "barcode_scanner.html"}}
{{new_item_js_url = URL('static', 'js/create_item.js')}}

<div>
  <div>
    <div class="panel panel-primary" hidden="hidden" id="new_item_panel">
      <div class="panel-heading">{{=T('New Item')}}
        <button class="btn btn-default" id="cancel_new_item">{{=T('Cancel')}}</button>
      </div>
      <div class="panel-body" id="new_item_form_container">
      </div>

    </div>
  </div>
</div>


<div>
  <!-- Items list -->
  <div id="items_list"></div>
  <!-- buttons -->
    <div>
      <button class="btn btn-primary" id="commit_btn">
        {{=T('Commit')}}
      </button>
      <button class="btn btn-default" id="save_btn">
        {{=T('Save')}}
      </button>
    </div>
</div>


<!-- Prototype element for purchase items list  -->
<div href="#" class="list-group-item" id="proto_item">
  <h4> <span class="item_name"></span> <i class="fa fa-times right close"></i></h4>
  <p><i class="fa fa-barcode"> </i> <span class="barcode"></span></p>
  <div class="form-inline">

    <div class="form-group">
      <label class="control-label">{{=T('Quantity')}} </label>
      <input type="text" class="form-control quantity" name="quantity" placeholder="{{=T('Quantity')}}">
    </div>
    <div class="form-group">
      <label class="">{{=T('Buy Price')}}</label>
      <input type="text" class="form-control price" name="price" placeholder="{{=T('Buy Price')}}">
    </div>

    <div class="form-group">
      <label>{{=T('Taxes')}}</label>
      <input type="text" class="form-control taxes" placeholder="{{=T('Taxes')}}" disabled>
    </div>

    <!-- Prices -->
    <div class="form-group">
      <label class="">{{=T('Base Price')}}</label>
      <input type="text" class="form-control base_price" placeholder="{{=T('Sale Price')}}">
    </div>
    <div class="form-group">
      <label class="">{{=T('Price 2')}}</label>
      <input type="text" class="form-control price2" placeholder="{{=T('Sale Price')}}">
    </div>
    <div class="form-group">
      <label>{{=T('Price 3')}}</label>
      <input type="text" class="form-control price3" placeholder="{{=T('Sale Price')}}">
    </div>

    <button class="btn btn btn-default show-serials">{{=T('Serial numbers')}}</button>
    <div>
      <div class="form-group serial_numbers_fg" style="width: 100%; display: None">
        <label>{{=T('Serial Numbers')}}</label>
        <textarea class="form-control serial_numbers" name="" id="" rows="10" style="width: 100%; resize: none;" cols="auto"></textarea>
      </div>
    </div>
  </div>
</div>




<script>
  $('#proto_item').hide();


  $('#purchase_form input').change(function (event) {
    $.ajax({
      url: "{{=URL('update_value', args=purchase.id)}}?" + event.target.name + '=' + event.target.value
    })
    .done(function (res) {
      
    })
    .fail(function (res) {

    })
  });


  $('#save_btn').on('click', function() {
    window.location.href = '{{=URL("save", args=purchase.id)}}';
  });

  $('#commit_btn').on('click', function() {
    window.location.href = '{{=URL("commit", args=purchase.id)}}';
  });


  $('#cancel_new_item').on('click', function() {
    $('#new_item_form').remove();
    $('#new_item_panel').hide();
    $('#barcode__purchases').val("");
  });

  function remove_item(key, stock_item_id) {
    $('#' + key).remove();
    $.ajax({
      url: "{{=URL('delete_stock_item', extension='json')}}/" + stock_item_id
    })
    .done(function (data) {
      console.log(data);
    })
  }

  function refresh_stock_item(pitem) {
    var key = "#item_" + pitem.item.barcode;

    $(key).find('.quantity').val(pitem.purchase_qty);
    $(key).find('.price').val(pitem.price);
    $(key).find('.taxes').val(pitem.taxes);
    $(key).find('.base_price').val(pitem.base_price);
    $(key).find('.price2').val(pitem.price2);
    $(key).find('.price3').val(pitem.price3);
    $(key).find('.serial_numbers').val(pitem.serial_numbers);
  }


  function call_stock_item_modifier(stock_item_id, param_name, param_value, barcode) {
    if (!param_value) {return false}
    // $('#item_' + barcode).addClass('bg-warning');
    $('#item_' + barcode).css('background-color', '#FCF8E3');
    $.ajax({
      url: '{{=URL("modify_stock_item", extension="json")}}/' + stock_item_id + '/' + param_name + '/' + param_value
    })
    .done(function(res) {
      refresh_stock_item(res);

      $('#item_' + barcode).css('background-color', '#DFF0D8');
      window.setTimeout(function() {
        $('#item_' + barcode).css('background-color', 'white');
      }, 800)
    });
  }


  // clones the proto html item list element and cofigures the newly created element
  function create_html_item(item, barcode, stock_item) {
    var key = 'item_' + barcode;
    var el_item = $('#proto_item').clone();
    el_item.attr('id', key);
    el_item.show();
    el_item.css('display', 'block');
    var pitem_id = stock_item.id;
    el_item.find('.item_name').html(item.name);
    el_item.find('.close').on('click', function() {remove_item(key, stock_item.id);});
    el_item.find('.barcode').text(barcode);

    var quantity = el_item.find('.quantity');
    var buy_price = el_item.find('.price');
    var base_price = el_item.find('.base_price');
    var price2 = el_item.find('.price2');
    var price3 = el_item.find('.price3');
    var serial_numbers = el_item.find('.serial_numbers')

    $('#items_list').prepend(el_item);
    refresh_stock_item(stock_item);

    quantity.on('change', function() {
      call_stock_item_modifier(pitem_id, 'purchase_qty', parseFloat($(this).val()), barcode);
    });

    buy_price.on('change', function() {
      call_stock_item_modifier(pitem_id, 'price', parseFloat($(this).val()), barcode);
    });

    base_price.on('change', function() {
      call_stock_item_modifier(pitem_id, 'base_price', parseFloat($(this).val()), barcode);
    });
    price2.on('change', function() {
      call_stock_item_modifier(pitem_id, 'price2', parseFloat($(this).val()), barcode);
    });
    price3.on('change', function() {
      call_stock_item_modifier(pitem_id, 'price3', parseFloat($(this).val()), barcode);
    });

    serial_numbers.on('change', function() {
      call_stock_item_modifier(pitem_id, 'serial_numbers', $(this).val(), barcode);
    });

    el_item.find('.show-serials').click(function(event) {
      el_item.find('.serial_numbers_fg').toggle();
    })
  }


  $("#bundle_form").on('submit', function(event) {
    event.preventDefault();
    $('#no_table_scan_code').focus();
    return false;
  });



  // replaces default form submission, in order to send an ajax request to fetch the barcode and create the purchase item

  function success_callback(data, barcode) {
    var item = data;
    $.ajax({
      url: "{{=URL('add_stock_item', args=purchase.id, extension='json')}}/" + item.id
    })
    .done(function(data) {
      create_html_item(item, barcode, data.stock_item);
    })
    .fail(function(data) {
      alert("{{=T('Could not add item!')}}")
    });
  }

  function fail_callback(data, barcode) {
    // this happens when the item wasn't found, so we need to display the item
    // creation form.
    $('#new_item_form_container > *').remove();
    $.ajax({
      url: "{{=URL('item', 'create_or_update', extension='json')}}"
    })
    .done(function (data) {
      $('#new_item_form_container').append(data.form);
      var new_item_form = $('#new_item_form_container').find('form');
      new_item_form.attr('id', 'new_item_form');
      new_item_form.find('#item_sku').val(barcode);
      // avoids default submit
      new_item_form.on('submit', function(event) {
        event.preventDefault();

        // remove all errors
        $(this).find('.error_wrapper').remove();

        var item_data = {
            name: $('#item_name').val()
          , sku: $('#item_sku').val()
          , ean: $('#item_ean').val()
          , upc: $('#item_upc').val()
          , description: $('#item_description').val()
          , id_brand: $('#item_id_brand').val()
          , categories: $('#categories_selected').val()
          , traits: $('#traits_selected').val()
          , has_inventory: $('#item_has_inventory').prop('checked')
          , base_price: $('#item_base_price').val()
          , price2: $('#item_price2').val()
          , price3: $('#item_price3').val()
          , id_measure_unit: $('#item_id_measure_unit').val()
          , taxes: $('#item_taxes').val()
          , allow_fractions: $('#item_allow_fractions').prop('checked')
          , reward_points: $('#item_reward_points').val()
        };
        url = "{{=URL('add_item_and_stock_item', args=purchase.id, extension='json')}}?"
        for (var prop in item_data) {
          if (item_data.hasOwnProperty(prop)) {
            url += prop + '=' + item_data[prop] + '&'
          }
        }
        $.ajax({
          url: url
        })
        .done(function (data) {
          // display the errors returned by the server
          if (data.errors) {
            for (var prop in data.errors) {
              $('#item_' + prop + '__row').find('.help-block').before('<div class="error_wrapper"><div class="error">' + data.errors[prop] + '</div></div>')
            }
          }
          else {
            // add the new purchase item to the list
            create_html_item(data.item, barcode, data.stock_item);
            $('#new_item_form').remove();
            $('#new_item_panel').hide();
          }
        })
        .fail(function (data) {
          console.log('error: ' + data);
        })

        return false;
      });
      item_id = "";
      $.getScript('{{=new_item_js_url}}');
      $('#new_item_panel').show();
    });
  }

  function requirement(barcode) {
    var el_item = $('#items_list').find('#item_' + barcode);
    console.log(el_item);
    if (el_item.length) {
      return false;
    }
    else {
      return true;
    }
  }

  setup_scanner(success_callback, fail_callback, requirement, null, 'purchases');


  // purchase_items is a javascript variable sended by the server. in the purchase_items_form
  for (var i in stock_items) {
    var stock_item = stock_items[i];
    create_html_item(stock_item.item, stock_item.item.barcode, stock_item);
  }

</script>
