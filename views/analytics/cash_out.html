{{left_sidebar_enabled = True}}
{{extend "layout.html"}}

{{import random}}
{{import datetime}}
{{from gluon.serializers import json}}

<h1>{{=T('Details')}}</h1>
{{if not sales:}}
  <p>{{=T("No sales reported")}} </p>
{{else:}}

  {{block left_sidebar}}
    <h1>{{=T("Cash out")}}</h1>
    <h4>{{=T("Seller")}}: {{=seller.first_name}}</h4>
    <div>
      <canvas id="payment_opt_distrib" style="width: 100%;"></canvas>
    </div>

    <h3>{{=T('Total')}}: <span class="right">$ {{=total}} </span></h3>
    <h3>{{=T('Total Cash')}}: <span class="right">$ {{=total_cash}}</span></h3>
    <hr>
    <div class="form-group">
      <label for="phys_cash">{{=T('Physical cash')}}:</label>
      <input type="number" class="form-control" id="phys_cash" name="phys_cash">
    </div>
    <div class="form-group">
      <label for="cash_out_notes">{{=T('Notes')}}:</label>
      <textarea id="cash_out_notes" name="cash_out_notes" rows="8" cols="40" class="form-control">
      </textarea>
    </div>
    <a class="btn btn-primary btn-block" href="">{{=T('Save')}}</a>
  {{end}}

  <h2>{{=T("Sales")}}</h2>

  {{for sale in sales:}}
    <div>
      <div class="media">
        <div class="media-left media-top">
          <a href="{{=URL('sale', 'ticket', args=sale.id)}}" target="_blank">
            <h3>#{{=sale.id}}</h3>
          </a>
        </div>
        <div class="media-body" style="padding-left: 16px;">
          <div class="sale-data">
            <h4> {{=sale.created_on}} </h4>
            <h4 class="right"> $ {{=DQ(sale.total, True)}} </h4>
          </div>
            <div class="progress sale-progress" style="margin-bottom:0px;">
              {{for payment_key in sale.payments.iterkeys(): }}
                {{ payment_opt = payment_opt_data[payment_key] }}
                {{ payment = sale.payments[payment_key]}}
                {{ hex = payment_opt["color"] }}

                {{payment_amount = payment.amount - payment.change_amount}}
                {{p = payment.amount / (sale.payments_total + sale.change) * DQ(100, True)}}
                <div class="progress-bar" style="width: {{=p}}%; background-color: {{=hex}}; font-size: 14px;">
                  <span>{{=payment_opt['label']}}: {{=DQ(payment.amount, True)}}</span>
                  {{ payment_opt['value'] += DQ(payment_amount, True) }}
                </div>
                {{p = sale.change / (sale.payments_total + sale.change) * DQ(100, True)}}
                <div class="progress-bar" style="width: {{=p}}%; background-color: #333; font-size: 14px;">
                  <span>{{=T('Change')}}: {{=DQ(sale.change, True)}}</span>
                </div>
              {{pass}}
            </div>
        </div>
      </div>
    </div>
  {{pass}}


  {{block page_js}}
    {{=SCRIPT("var payment_opt_distrib = %s" % json(payment_opt_data) )}}
    <script src="{{=URL('static', 'js/Chart.js')}}" charset="utf-8"></script>
    <script type="text/javascript">
      var ctx = document.getElementById("payment_opt_distrib").getContext("2d");
      var myDoughnutChart = new Chart(ctx).Pie(payment_opt_distrib, null);
    </script>
  {{end}}

{{pass}}
