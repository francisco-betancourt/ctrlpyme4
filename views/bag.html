
<div class="btn-group btn-group-justified" role="group" aria-label="...">
  <div class="btn-group" role="group">
    <button class="btn btn-primary btn-block" id="add_bag_btn">{{=T('Add Bag')}}</button>
  </div>
  <div class="btn-group" role="group">
    <button type="button" class="btn btn-default" onclick="show_active_bags();">{{=T('Bags')}} {{=ICON('arrow_drop_down')}}</button>
  </div>
</div>

<br>


<!-- Active bags -->
<div class="list-group" id="active_bags" hidden="hidden">
  {{for bag in db((db.bag.is_active == True) & (db.bag.created_by == auth.user.id) & (db.bag.id_store == session.store) & (db.bag.completed == False)).select():}}
    <a href="#" class="list-group-item" onclick="load_bag({{=bag.id}});" id="bag_selector_{{=bag.id}}">
      {{=T('Bag')}} {{=bag.id}}
    </a>
  {{pass}}
</div>

<!-- Bag -->
<div class="panel panel-default" id="current_bag">
  <div class="panel-heading">
    <h3>{{=T('Bag')}} <span id="bag_id"></span> (<span class="bag_quantity"></span> {{=T('items')}})
      {{=ICON('expand_less', _class="right collapse_bag")}}
    </h3>
  </div>
  <div class="panel-body bag-items-panel">
    <div id='barcode_scanner_container' style="padding-left: 15px; padding-right: 15px;">
      {{include 'barcode_scanner.html'}}
    </div>

    <div class="list-group" id="bag_items_list">
    </div>
  </div>

  <div class="panel-footer">
    <p> <span>{{=T('Subtotal')}}</span> <span class="right subtotal">00</span> </p>
    <p> <span>{{=T('Taxes')}}</span> <span class="right taxes">00</span> </p>
    <p> <span>{{=T('Total')}}</span> <span class="right total">00</span> </p>
    <hr>

    <a class="btn btn-primary btn-block sell_bag" href="{{=URL('bag', 'complete')}}">
      {{=T('Complete')}}
    </a>
    {{if auth.has_membership('Stock transfers'):}}
      <button class="btn btn-default btn-block transfer_bag" onclick="transfer_bag();">
        {{=T('Stock transfer')}}
      </button>
    {{pass}}
    <button class="btn btn-default btn-block discard_bag" onclick="discard_bag();">
      {{=T('Discard')}}
    </button>
  </div>
</div>




<div id="proto_bag_item" class="list-group-item" hidden="hidden">
  <div>
    <h4><span class="item_name"></span> <span class="text-danger"><span class="discount"></span>% {{=T('OFF')}}</span>
      {{=ICON("close", _class="right close")}}
    </h4>
    <p><span class="item_stock"></span></p>
    <p><span class="item_price base_price"></span></p>
    <p>
      <div class="btn-group btn-group-justified extra_prices" role="group" aria-label="...">
        <a type="button" class="btn btn-default item_price"></a>
        <a type="button" class="btn btn-default price2"></a>
        <a type="button" class="btn btn-default price3"></a>
      </div>
    </p>

    <div class="input-group">
      <div class="input-group-addon">{{=T('Quantity')}}</div>
      <input type="number" class="form-control item_qty">
      <div class="input-group-addon munit"></div>
    </div>
  </div>
</div>


<!-- modal data -->
<div id="access_code_modal_body">
  <input type="password" id="access_code" class="form-control">
</div>
<div id="access_code_modal_footer">
  <button type="button" class="btn btn-default" data-dismiss="modal">{{=T("Close")}}</button>
  <button type="button" class="btn btn-primary submit">
    {{=T('Authenticate')}}
  </button>
</div>

<script>
  set_modal("{{=T('Manager access')}}", $('#access_code_modal_body').detach(), $('#access_code_modal_footer').detach());
</script>


<script>

  function add_bag() {
    $.ajax({
      url: "{{=URL('bag', 'create', extension='json')}}"
    })
    .done(function (data) {
      load_bag(data.bag);

      // add the new bag to the active bags list
      var bag_selector = document.createElement('a');
      bag_selector.id = 'bag_selector_' + data.bag;
      bag_selector.innerHTML = '{{=T("Bag")}} ' + data.bag;
      bag_selector.href = '#';
      bag_selector.className = 'list-group-item';
      $('#active_bags').append(bag_selector);
      $('#bag_selector_' + data.bag).click(function(event) {
        load_bag(data.bag);
      });
    })
  }
</script>


<!-- Scanner script -->
<script>

  function set_bag_data(data) {
    $('#current_bag .subtotal').text(data.subtotal);
    $('#current_bag .taxes').text(data.taxes);
    $('#current_bag .total').text(data.total);

    $('#current_bag .bag_quantity').text(data.quantity);
  }


  var price_index = null;
  var bag_item_id = null;
  var target = null;


  function validate_access_code() {
    $.ajax({
      url: "{{=URL('bag', 'change_bag_item_sale_price', extension='json')}}/" + price_index + '/' + bag_item_id + '/' + $('#access_code').val()
    })
    .done(function (data) {
      $('#modal').modal('hide');
      $(target).parent().find('.btn-primary').removeClass('btn-primary');
      $(target).addClass('btn-primary');

      set_bag_data(data)

      $('#common_modal').modal('hide');
      $('#access_code').val('');
    })
    .fail(function (data) {
      $('#common_modal').modal('hide');
      alert('{{=T("Invalid access")}}');
    });
  }


  $('#common_modal').find('.submit').click(function (event) {
    validate_access_code();
  });


  function set_sale_price(_price_index, _bag_item_id, _target) {
    price_index = _price_index;
    bag_item_id = _bag_item_id;
    target = _target;

    {{if auth.has_membership('Admin') or auth.has_membership('Manager'):}}
      validate_access_code();
    {{else:}}
      $('#common_modal').modal();
    {{pass}}
  }


  function base_add_bag_item(bag_item, res) {
    if (res.status) {
      alert(res.status);
      return;
    }
    var item = $('#bag_items_list').find('#bag_item_' + bag_item.id)[0];
    if (item) {
      $(item).find('.item_qty').val(bag_item.quantity);
    }
    else {
      $('#bag_items_list').prepend(clone_proto_item(bag_item, bag_item.barcode));
    }
    set_bag_data(res)
    info_card("{{=T('Added item to bag')}}");
    show_container('bag_container');
  }


  function clone_proto_item(data, barcode) {
    var new_item = $('#proto_bag_item').clone();
    var new_item_id = 'bag_item_' + data.id;
    new_item.attr('id', new_item_id);
    new_item.attr('barcode', barcode);
    new_item.attr('itemid', data.id_item);
    new_item.find('.item_name').text(data.product_name);
    new_item_stock = new_item.find('.item_stock');
    if (!data.has_inventory) {
      new_item_stock.text("{{=T('Available')}}");
      new_item_stock.addClass('text-success');
    }
    else {
      if (data.stock <= 0) {
        new_item_stock.text("{{=T('Out of stock')}}");
        new_item_stock.addClass('text-danger');
      }
      else {
        new_item_stock.text('{{=T("only")}} ' + data.stock + ' {{=T("left")}}');
      }
    }

    new_item.find('.item_price').text(data.base_price);

    if (data.price2 || data.price3) {
      new_item.find('.base_price').parent().remove();
      var base_price_btn = new_item.find('.item_price');
      var price2_btn = new_item.find('.price2');
      var price3_btn = new_item.find('.price3');

      if (data.sale_price == data.price2) {
        price2_btn.addClass('btn-primary');
      }
      else if (data.sale_price == data.price3) {
        price3_btn.addClass('btn-primary');
      }
      else {
        base_price_btn.addClass('btn-primary');
      }

      base_price_btn.click(function(event) {
        set_sale_price(1, data.id, event.target);
      });

      if (data.price2) {
        price2_btn.text(data.price2);
        price2_btn.click(function(event) {
          set_sale_price(2, data.id, event.target);
        });
      }
      else {
        price2_btn.remove();
      }
      if (data.price3) {
        price3_btn.text(data.price3);
        price3_btn.click(function(event) {
          set_sale_price(3, data.id, event.target);
        });
      }
      else {
        price3_btn.remove();
      }
    }
    else {
      new_item.find('.extra_prices').remove();
    }

    if (data.discount_percentage == 0) {
      new_item.find('.discount').parent().remove();
    }
    else {
      new_item.find('.discount').text(data.discount_percentage);
    }

    new_item.find('.item_qty').val(data.quantity);
    new_item.find('.munit').text(data.measure_unit);

    new_item.find('.close').click(function(event) {
      $.ajax({
        url: "{{=URL('bag', 'delete_bag_item', extension='json')}}/" + data.id
      })
      .done(function(res) {
        $('#' + new_item_id).remove();
        set_bag_data(res)
      })
    })

    new_item.find('.item_qty').change(function (event) {
      $.ajax({
        url: "{{=URL('bag', 'modify_bag_item', extension='json')}}/" + data.id + '?quantity=' + $(this).val()
      })
      .done(function (data) {
        new_item.find('.item_qty').val(data.bag_item.quantity)
        set_bag_data(data)
      })
    });

    new_item.show();

    return new_item;
  }

  function requirement(barcode) {
    return true;
  }

  function success_callback(data, barcode) {
    $.ajax({
      url: "{{=URL('bag', 'add_bag_item', extension='json')}}/" + data.id
    })
    .done(function (res) {
      if (res.status == "out of stock") {
        alert('{{=T("Out of stock!!!")}}');
      }
      else {
        bag_item = res.bag_item;
        base_add_bag_item(bag_item, res);
      }
    })
  }


  function fail_callback(data, barcode) {

  }

  setup_scanner(success_callback, fail_callback, requirement);
</script>


<script>
  function show_active_bags() {
    $('#active_bags').toggle();
  }

  function load_bag(bag_id) {
    // retrieve bag items
    $.ajax({
      url: "{{=URL('bag', 'select_bag', extension='json')}}/" + bag_id
    })
    .done(function (data) {
      var bag = data.bag
      $('#bag_items_list').children().remove();
      $('#bag_id').text(bag.id);

      for (var bag_item_id in data.bag_items) {
        var bag_item = data.bag_items[bag_item_id]
        $('#bag_items_list').prepend(clone_proto_item(bag_item, bag_item.barcode));
      }

      set_bag_data(data);

      $('#active_bags').hide();
      $('#current_bag').show();
    })
    .fail(function (data) {
      console.log('Could not load the bag');
    });
  }


  function add_bag_item(item_id) {
    $.ajax({
      url: "{{=URL('bag', 'add_bag_item', extension='json')}}/" + item_id
    })
    .done(function (res) {
      bag_item = res.bag_item;
      base_add_bag_item(bag_item, res);
    })
    .fail(function (res) {
      console.log(res);
    })
  }


  $('#add_bag_btn').on('click', function(event) {
    $.ajax({
      url: "{{=URL('bag', 'create', extension='json')}}"
    })
    .done(function (data) {
      load_bag(data.bag);

      // add the new bag to the active bags list
      var bag_selector = document.createElement('a');
      bag_selector.id = 'bag_selector_' + data.bag;
      bag_selector.innerHTML = '{{=T("Bag")}} ' + data.bag;
      bag_selector.href = '#';
      bag_selector.className = 'list-group-item';
      $('#active_bags').append(bag_selector);
      $('#bag_selector_' + data.bag).click(function(event) {
        load_bag(data.bag);
      });
    })
  });


  function discard_bag() {
    $.ajax({
        url: "{{=URL('bag', 'discard_bag', extension='json')}}"
      })
      .done(function (res) {
        var removed = res.removed;
        $('#bag_selector_' + removed).remove();
        if (res.other_bag) {
          load_bag(res.other_bag.id)
        }
        else {
          add_bag();
        }
        return false;
      })
  }


  function transfer_bag() {
    var r = confirm("{{=T('Confirm stock transfer?')}}");
    if (r == true) window.location.href = "{{=URL('bag', 'stock_transfer')}}";
  }

  $('#proto_bag_item').hide();

  $('.panel').find('.collapse_bag').on('click', function(event) {
    var el_bag_panel_body = $('#current_bag .panel-body');
    if (el_bag_panel_body.css('display') == 'none') {
      $(event.target).text('expand_less');
    } else {
      $(event.target).text('expand_more');
    }
    el_bag_panel_body.toggle();
  });

  {{ if session.current_bag: }} load_bag({{=session.current_bag}}); {{ pass }}

</script>
